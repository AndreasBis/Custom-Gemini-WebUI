<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Gemini Web Chat</title>
    <link rel='preconnect' href='https://fonts.googleapis.com'>
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
    <link href='https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500&display=swap' rel='stylesheet'>
    <link rel='stylesheet' href='{{ url_for('static', filename='style.css') }}'>
</head>
<body>

    {% if not model_is_selected and not error %}
    <div class='modal-overlay' id='modal-overlay'>
        <div class='modal-content'>
            <h2>Select a Model</h2>
            <p>Choose which Gemini model you'd like to chat with.</p>
            <form action='{{ url_for('select_model') }}' method='POST' class='model-picker-form'>
                <button type='submit' name='model_choice' value='gemini-2.5-pro'>
                    <strong>Gemini 2.5 Pro</strong>
                    <span>(Strongest, for complex tasks)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.5-flash'>
                    <strong>Gemini 2.5 Flash</strong>
                    <span>(Fast & capable, for general use)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.5-flash-lite'>
                    <strong>Gemini 2.5 Flash Lite</strong>
                    <span>(Lightweight, for speed)</span>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class='modal-overlay' id='rename-modal-overlay' style='display: none;'>
        <div class='modal-content'>
            <h2>Rename Chat</h2>
            <p>Enter a new title for this chat.</p>
            <form id='rename-form' action='' method='POST' class='rename-form'>
                <input type='text' name='new_title' id='rename-input' placeholder='New chat title...' required autocomplete='off'>
                <div class='rename-actions'>
                    <button type='button' id='rename-cancel-btn'>Cancel</button>
                    <button type='submit'>Rename</button>
                </div>
            </form>
        </div>
    </div>

    <div class='modal-overlay' id='deletion-modal-overlay' style='display: none;'>
        <div class='modal-content'>
            <h2>Confirm Deletion</h2>
            <p id='deletion-modal-text'>The agent wants to run a destructive command. Are you sure?</p>
            <div class='modal-actions'>
                <button type='button' class='cancel-btn' id='deletion-cancel-btn'>Deny</button>
                <button type='button' class='confirm-btn' id='deletion-confirm-btn'>Approve</button>
            </div>
        </div>
    </div>

    <div class='app-layout sidebar-hidden' id='app-layout'>

        <div class='sidebar' id='sidebar'>
            <a href='{{ url_for('new_chat') }}' class='new-chat-btn'>+ New Chat</a>
            <nav class='chat-history-list'>
                {% for chat in all_chats %}
                <div class='chat-history-item-wrapper {% if chat.id == current_chat_id %}active{% endif %}'>
                    <a href='{{ url_for('chat', chat_id=chat.id) }}' class='chat-history-item'>
                        {{ chat.title }}
                    </a>
                    <div class='chat-options'>
                        <button class='kebab-btn' title='Chat options' data-chat-id='{{ chat.id }}' data-chat-title='{{ chat.title }}'>â‹®</button>
                        <div class='kebab-dropdown'>
                            <button type='button' class='rename-btn'>Rename</button>
                            <a href='{{ url_for('download_chat', chat_id=chat.id) }}'>Download</a>
                            <form action='{{ url_for('delete_chat', chat_id=chat.id) }}' method='POST' onsubmit='return confirm("Delete this chat permanently?");'>
                                <button type='submit'>Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </nav>
        </div>

        <div class='resizer' id='resizer'></div>

        <div class='container'>
            <div class='header'>
                <div class='header-left'>
                    <button class='menu-btn' id='menu-btn' title='Toggle Menu'>
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
                
                <div class='header-center'>
                    <h1 class='chat-title'>
                        {% if model_is_selected %}{{ current_chat.title }}{% else %}Gemini Chat{% endif %}
                    </h1>
                </div>
                
                <div class='header-right'>
                    <div class='agent-toggle'>
                        <span>Agent Mode</span>
                        <label class='switch'>
                            <input type='checkbox' id='agent-mode-toggle'>
                            <span class='slider'></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class='chat-window' id='chat-window'>
                {% for message in current_chat_messages %}
                    <div class='message {{ message.role }} {{ message.message_type }}' {% if message.message_type == 'agent_plan' and message.raw_content %}data-raw-plan-json='{{ message.raw_content }}'{% endif %} data-raw-copy-data='{{ message.raw_content }}'>
                        <div class='bubble'>
                            <div class='bubble-content'>{{ message.content | safe }}</div>
                            {% if message.message_type not in ['agent_plan', 'user_confirmation'] %}
                            <button class='copy-btn' title='Copy content'>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                  <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                  <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 1.5A1.5 1.5 0 0 1 .5 0h3A1.5 1.5 0 0 1 5 1.5v1A1.5 1.5 0 0 1 3.5 4h-3A1.5 1.5 0 0 1 -1 2.5v-1zM.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-3z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
                <div id='chat-end'></div>
            </div>
            
            {% if error %}
                <div class='error-banner'>
                    <strong>Application Error:</strong> {{ error }}
                </div>
            {% endif %}
            
            <form id='chat-form' class='chat-form'>
                <textarea 
                    id='prompt-input'
                    name='prompt' 
                    placeholder='{% if model_is_selected %}Enter your message or task... (Shift+Enter for new line){% else %}Please select a model to begin{% endif %}' 
                    autocomplete='off' 
                    required 
                    rows='1'
                    {% if not model_is_selected or error %}disabled{% endif %}
                ></textarea>
                <button 
                    type='submit' 
                    id='send-button'
                    {% if not model_is_selected or error %}disabled{% endif %}
                >Send</button>
            </form>
        </div>
    </div>
    
    <script>
        const menuBtn = document.getElementById('menu-btn');
        const appLayout = document.getElementById('app-layout');
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        let typingBubble = null;
        let isPlanRunning = false;
        
        menuBtn.addEventListener('click', () => {
            appLayout.classList.toggle('sidebar-hidden');
            if (appLayout.classList.contains('sidebar-hidden')) {
                resizer.style.pointerEvents = 'none';
            } else {
                resizer.style.pointerEvents = 'auto';
            }
        });

        const modalOverlay = document.getElementById('modal-overlay');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(event) {
                if (event.target === modalOverlay) { 
                    {% if fallback_chat_id %}
                    window.location.href = '{{ url_for('chat', chat_id=fallback_chat_id) }}';
                    {% else %}
                    window.location.href = '{{ url_for('index') }}';
                    {% endif %}
                }
            });
        }
    
        window.addEventListener('load', (event) => { scrollToBottom(); });

        const chatForm = document.getElementById('chat-form');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const chatWindow = document.getElementById('chat-window');
        const agentToggle = document.getElementById('agent-mode-toggle');

        
        agentToggle.addEventListener('change', () => {
            localStorage.setItem('agentMode', agentToggle.checked);
        });

        function loadAgentMode() {
            const savedState = localStorage.getItem('agentMode');
            if (savedState === 'true') {
                agentToggle.checked = true;
            } else {
                agentToggle.checked = false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadAgentMode);

        chatForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            handleChatSubmit();
        });

        promptInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const scrollHeight = this.scrollHeight;
            const maxHeight = parseInt(getComputedStyle(this).maxHeight);

            if (scrollHeight > maxHeight) {
                this.style.overflowY = 'auto';
                this.style.height = maxHeight + 'px';
            } else {
                this.style.overflowY = 'hidden';
                this.style.height = scrollHeight + 'px';
            }
        });

        promptInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                chatForm.requestSubmit();
            }
        });
        
        function showTypingIndicator() {
            if (typingBubble) {
                typingBubble.remove();
            }
            typingBubble = appendMessage('model', '<div class="typing-indicator"><span></span><span></span><span></span></div>', 'typing');
            scrollToBottom();
        }
        
        function removeTypingIndicator() {
            if (typingBubble) {
                typingBubble.remove();
                typingBubble = null;
            }
        }
        
        function enableChatInput() {
            promptInput.disabled = false;
            sendButton.disabled = false;
            promptInput.focus();
        }
        
        function disableChatInput() {
            promptInput.disabled = true;
            sendButton.disabled = true;
        }

        async function handleChatSubmit() {
            const prompt = promptInput.value.trim();
            if (prompt === '' || isPlanRunning) { return; }

            const agentMode = agentToggle.checked;

            promptInput.value = '';
            disableChatInput();
            promptInput.style.height = 'auto';
            promptInput.style.overflowY = 'hidden';
            
            appendMessage('user', prompt, 'chat', null, prompt);
            showTypingIndicator();

            try {
                const response = await fetch("{{ url_for('api_chat') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        'prompt': prompt,
                        'agent_mode': agentMode
                    }),
                });

                removeTypingIndicator();
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }
                
                const data = await response.json();
                
                let rawDataForCopy = data.raw_plan;
                if (data.message_type === 'chat') {
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.content;
                    const meta = tempDiv.querySelector('.msg-meta');
                    if (meta) { meta.remove(); }
                    rawDataForCopy = tempDiv.innerText;
                }
                
                appendMessage(data.role, data.content, data.message_type, null, rawDataForCopy, data.raw_plan);
                
                if (data.message_type === 'agent_plan' || data.message_type === 'user_confirmation') {
                    disableChatInput();
                } else {
                    enableChatInput();
                }
                
            } catch (error) {
                removeTypingIndicator();
                appendMessage('model', `--- Error connecting to server: ${error.message} ---`, 'chat', null, `Error: ${error.message}`);
                console.error('Fetch Error:', error);
                enableChatInput();
            } finally {
                scrollToBottom();
            }
        }
        
        function approvePlan(chatId, buttonEl) {
            if (isPlanRunning) return;
            
            const planActions = buttonEl.closest('.plan-actions');
            planActions.innerHTML = '<p>Executing plan...</p>';
            
            executePlan(chatId);
        }
        
        async function executePlan(chatId) {
            if (isPlanRunning) return;
            isPlanRunning = true;
            disableChatInput();
            showTypingIndicator();
            
            try {
                const response = await fetch(`/api/execute_plan/${chatId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                removeTypingIndicator();
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }
                
                const data = await response.json();

                if (data.status === 'proceed') {
                    isPlanRunning = false; 
                    executePlan(chatId); 
                } else if (data.status === 'confirmation_pending' || data.status === 'file_selection_pending') {
                    appendMessage('model', data.content, 'user_confirmation');
                    scrollToBottom();
                    isPlanRunning = false; 
                    disableChatInput(); 
                } else if (data.status === 'complete') {
                    const rawText = data.message.replace(/<.*?>/g, '');
                    appendMessage('model', data.message, 'chat', null, rawText);
                    isPlanRunning = false;
                    enableChatInput();
                } else if (data.status === 'error') {
                    throw new Error(data.message);
                }

            } catch (error) {
                removeTypingIndicator();
                appendMessage('model', `--- Agent Error: ${error.message} ---`, 'chat', null, `Agent Error: ${error.message}`);
                isPlanRunning = false;
                enableChatInput();
            } finally {
                scrollToBottom();
            }
        }
        
        function handleDeletion(command, chatId, buttonEl) {
            if (isPlanRunning) return;
            
            const planActions = buttonEl.closest('.plan-actions');
            planActions.innerHTML = '<p>Confirming deletion...</p>';
            
            showDeletionModal(chatId, command);
        }
        
        async function handleAgentAction(chatId, actionType, actionData) {
            if (isPlanRunning) return;
            isPlanRunning = true;
            
            document.querySelectorAll('.message.user_confirmation').forEach(el => el.remove());
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/agent_action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_type: actionType, action_data: actionData })
                });
                
                removeTypingIndicator();
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }
                
                const data = await response.json();
                
                if (data.status === 'proceed') {
                    isPlanRunning = false;
                    executePlan(chatId);
                } else {
                    throw new Error(data.message || 'Unknown error after action');
                }
                
            } catch (error) {
                removeTypingIndicator();
                appendMessage('model', `--- Agent Error: ${error.message} ---`, 'chat', null, `Agent Error: ${error.message}`);
                isPlanRunning = false;
                enableChatInput();
            } finally {
                scrollToBottom();
            }
        }

        function handleFileSelection(event, chatId) {
            event.preventDefault();
            if (isPlanRunning) return;
            
            const form = event.target;
            const formData = new FormData(form);
            const selectedFiles = formData.getAll('selected_files');
            
            form.closest('.message.user_confirmation').remove();
            
            handleAgentAction(chatId, 'process_selected_files', { selected_files: selectedFiles });
        }
        
        function cancelPlan() {
            document.querySelector('.message.agent_plan')?.remove();
            document.querySelectorAll('.message.user_confirmation').forEach(el => el.remove());
            
            appendMessage('model', 'Agent plan cancelled by user.', 'chat', null, 'Agent plan cancelled by user.');
            isPlanRunning = false;
            enableChatInput();
        }

        function editPlan(button, chatId) {
            if (isPlanRunning) return;
            disableChatInput();
            
            const bubble = button.closest('.bubble');
            const bubbleContent = bubble.querySelector('.bubble-content');
            const message = bubble.closest('.message');
            const rawPlan = message.dataset.rawPlanJson;

            if (!rawPlan) {
                alert('Error: Raw plan data not found.');
                return;
            }
            
            const originalHTML = bubbleContent.innerHTML;
            
            bubbleContent.innerHTML = `
                <textarea class="plan-editor">${JSON.stringify(JSON.parse(rawPlan), null, 2)}</textarea>
                <div class="plan-actions-edit">
                    <button id="save-plan-btn">Save & Approve</button>
                    <button id="cancel-edit-btn">Cancel Edit</button>
                </div>
            `;
            
            bubbleContent.querySelector('#save-plan-btn').onclick = () => savePlan(bubbleContent, chatId);
            bubbleContent.querySelector('#cancel-edit-btn').onclick = () => {
                bubbleContent.innerHTML = originalHTML;
                enableChatInput();
            };
        }

        async function savePlan(bubbleContent, chatId) {
            if (isPlanRunning) return;
            
            const textarea = bubbleContent.querySelector('.plan-editor');
            const newPlanJson = textarea.value;

            try {
                JSON.parse(newPlanJson); 
            } catch (e) {
                alert('Invalid JSON format. Please correct and try again.');
                return;
            }

            try {
                const response = await fetch('/api/save_plan/' + chatId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({plan_json: newPlanJson})
                });
                
                const data = await response.json();

                if (data.status === 'saved') {
                    bubbleContent.innerHTML = '<p>Plan saved. Executing...</p>';
                    executePlan(chatId);
                } else {
                    throw new Error(data.error || 'Failed to save plan');
                }
            } catch (err) {
                appendMessage('model', '--- Error saving plan: ' + err.message + ' ---', 'chat', null, `Error saving plan: ${err.message}`);
                scrollToBottom();
                enableChatInput();
            }
        }

        const deletionModal = document.getElementById('deletion-modal-overlay');
        const deletionText = document.getElementById('deletion-modal-text');
        const deletionConfirmBtn = document.getElementById('deletion-confirm-btn');
        const deletionCancelBtn = document.getElementById('deletion-cancel-btn');
        let currentDeletionCommand = null;
        let currentChatId = null;
        
        function showDeletionModal(chatId, command) {
            currentDeletionCommand = command;
            currentChatId = chatId;
            deletionText.innerHTML = `The agent wants to run: <code>${command}</code><br><br>Are you sure you want to approve this command?`;
            deletionModal.style.display = 'flex';
        }
        
        deletionCancelBtn.addEventListener('click', () => {
            deletionModal.style.display = 'none';
            cancelPlan();
        });
        
        deletionConfirmBtn.addEventListener('click', () => {
            deletionModal.style.display = 'none';
            if (currentChatId && currentDeletionCommand) {
                handleAgentAction(currentChatId, 'confirm_deletion', { command: currentDeletionCommand });
            }
        });
        
        document.addEventListener('click', function(e) {
            if (isPlanRunning) {
                e.stopImmediatePropagation();
                return;
            }
            
            const approveBtn = e.target.closest('.plan-actions .approve-btn');
            if (approveBtn) {
                const messageBubble = approveBtn.closest('.message.user_confirmation');
                if (messageBubble) {
                    const command = approveBtn.onclick.toString().match(/handleDeletion\("(.+?)"/);
                    if (command && command[1]) {
                        try {
                            const decodedCommand = JSON.parse(`"${command[1]}"`);
                            approveBtn.disabled = true;
                            approveBtn.innerText = 'Confirming...';
                            showDeletionModal('{{ current_chat_id }}', decodedCommand);
                        } catch(e) { console.error('Could not parse command', e); }
                    }
                }
            }
            
            const cancelBtn = e.target.closest('.plan-actions .cancel-btn');
            if (cancelBtn && (cancelBtn.closest('.message.user_confirmation') || cancelBtn.closest('.message.agent_plan'))) {
                cancelPlan();
            }
            
            const editBtn = e.target.closest('.plan-actions .edit-btn');
            if (editBtn) {
                editPlan(editBtn, '{{ current_chat_id }}');
            }
            
            const approvePlanBtn = e.target.closest('.plan-actions .approve-btn');
            if (approvePlanBtn && approvePlanBtn.closest('.message.agent_plan')) {
                approvePlan( '{{ current_chat_id }}', approvePlanBtn);
            }
        });


        function appendMessage(role, content, messageType = 'chat', bubbleClass = null, rawDataForCopy = null, rawPlanJson = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role, messageType);
            
            if (rawPlanJson) {
                messageDiv.dataset.rawPlanJson = rawPlanJson;
            }
            if (rawDataForCopy) {
                messageDiv.dataset.rawCopyData = rawDataForCopy;
            }
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('bubble');
            if (bubbleClass) { bubbleDiv.classList.add(bubbleClass); }

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('bubble-content');
            contentDiv.innerHTML = content; 
            
            bubbleDiv.appendChild(contentDiv);

            if (!bubbleClass && messageType !== 'agent_plan' && messageType !== 'user_confirmation') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.title = 'Copy content';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 1.5A1.5 1.5 0 0 1 .5 0h3A1.5 1.5 0 0 1 5 1.5v1A1.5 1.5 0 0 1 3.5 4h-3A1.5 1.5 0 0 1 -1 2.5v-1zM.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-3z"/></svg>`;
                
                copyBtn.addEventListener('click', () => {
                    const textToCopy = messageDiv.dataset.rawCopyData || contentDiv.innerText;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        copyBtn.classList.add('copied');
                        setTimeout(() => copyBtn.classList.remove('copied'), 1500);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                    });
                });
                bubbleDiv.appendChild(copyBtn);
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatWindow.insertBefore(messageDiv, document.getElementById('chat-end'));
            return messageDiv;
        }

        function scrollToBottom() {
            const chatEnd = document.getElementById('chat-end');
            if (chatEnd) { chatEnd.scrollIntoView(); }
        }
        
        function initCopyButtons() {
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const bubble = button.closest('.bubble');
                    const message = button.closest('.message');
                    const textToCopy = message.dataset.rawCopyData || bubble.querySelector('.bubble-content').innerText;
                    
                    if (textToCopy) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            button.classList.add('copied');
                            setTimeout(() => button.classList.remove('copied'), 1500);
                        }).catch(err => {
                            console.error('Failed to copy: ', err);
                        });
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initCopyButtons();
        
            const resizerEl = document.getElementById('resizer');
            const sidebarEl = document.getElementById('sidebar');
            const minWidth = 200; 
            const maxWidth = window.innerWidth * 0.33; 
            let isResizing = false;

            resizerEl.addEventListener('mousedown', function (e) {
                isResizing = true;
                document.body.classList.add('is-resizing');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                let newWidth = e.clientX;
                if (newWidth < minWidth) newWidth = minWidth;
                if (newWidth > maxWidth) newWidth = maxWidth;
                sidebarEl.style.width = newWidth + 'px';
            }

            function handleMouseUp() {
                isResizing = false;
                document.body.classList.remove('is-resizing');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        });

        const renameModal = document.getElementById('rename-modal-overlay');
        const renameForm = document.getElementById('rename-form');
        const renameInput = document.getElementById('rename-input');
        const renameCancel = document.getElementById('rename-cancel-btn');

        document.querySelectorAll('.kebab-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); 
                const chatId = this.dataset.chatId;
                const chatTitle = this.dataset.chatTitle;
                
                const dropdown = this.nextElementSibling;
                const renameBtn = dropdown.querySelector('.rename-btn');
                
                renameBtn.onclick = function() {
                    renameForm.action = `/rename_chat/${chatId}`;
                    renameInput.value = (chatTitle === 'New Chat') ? '' : chatTitle;
                    renameModal.style.display = 'flex';
                    renameInput.focus();
                    dropdown.classList.remove('show');
                };

                document.querySelectorAll('.kebab-dropdown.show').forEach(d => d.classList.remove('show'));
                dropdown.classList.toggle('show');
            });
        });

        window.addEventListener('click', function(e) {
            document.querySelectorAll('.kebab-dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        });

        renameCancel.addEventListener('click', () => {
            renameModal.style.display = 'none';
        });
        renameModal.addEventListener('click', function(event) {
            if (event.target === renameModal) {
                renameModal.style.display = 'none';
            }
        });

    </script>
</body>
</html>