<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Gemini Web Chat</title>
    <link rel='preconnect' href='https://fonts.googleapis.com'>
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
    <link href='https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500&display=swap' rel='stylesheet'>
    <link rel='stylesheet' href='{{ url_for('static', filename='style.css') }}'>
</head>
<body>

    {% if not model_is_selected and not error %}
    <div class='modal-overlay' id='modal-overlay'>
        <div class='modal-content'>
            <h2>Select a Model</h2>
            <p>Choose which Gemini model you'd like to chat with.</p>
            <form action='{{ url_for('select_model') }}' method='POST' class='model-picker-form'>
                <button type='submit' name='model_choice' value='gemini-2.5-pro'>
                    <strong>Gemini 2.5 Pro</strong>
                    <span>(Strongest, for complex tasks)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.5-flash'>
                    <strong>Gemini 2.5 Flash</strong>
                    <span>(Fast & capable, for general use)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.5-flash-lite'>
                    <strong>Gemini 2.5 Flash Lite</strong>
                    <span>(Lightweight, for speed)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.0-flash'>
                    <strong>Gemini 2.0 Flash</strong>
                    <span>(Older fast model)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.0-flash-lite'>
                    <strong>Gemini 2.0 Flash Lite</strong>
                    <span>(Older lightweight model)</span>
                </button>
                <button type='submit' name='model_choice' value='gemini-2.0-flash-exp'>
                    <strong>Gemini 2.0 Flash Exp</strong>
                    <span>(Experimental 2.0)</span>
                </button>
                <button type='submit' name_choice='model_choice' value='learnlm-2.0-flash-experimental'>
                    <strong>LearnLM 2.0 Flash Exp</strong>
                    <span>(Experimental learning model)</span>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class='modal-overlay' id='rename-modal-overlay' style='display: none;'>
        <div class='modal-content'>
            <h2>Rename Chat</h2>
            <p>Enter a new title for this chat.</p>
            <form id='rename-form' action='' method='POST' class='rename-form'>
                <input type='text' name='new_title' id='rename-input' placeholder='New chat title...' required autocomplete='off'>
                <div class='rename-actions'>
                    <button type='button' id='rename-cancel-btn'>Cancel</button>
                    <button type='submit'>Rename</button>
                </div>
            </form>
        </div>
    </div>

    <div class='modal-overlay' id='deletion-modal-overlay' style='display: none;'>
        <div class='modal-content'>
            <h2>Confirm Deletion</h2>
            <p id='deletion-modal-text'>The agent wants to run a destructive command. Are you sure?</p>
            <div class='modal-actions'>
                <button type='button' class='cancel-btn' id='deletion-cancel-btn'>Deny</button>
                <button type='button' class='confirm-btn' id='deletion-confirm-btn'>Approve</button>
            </div>
        </div>
    </div>

    <div class='app-layout sidebar-hidden' id='app-layout'>

        <div class='sidebar' id='sidebar'>
            <a href='{{ url_for('new_chat') }}' class='new-chat-btn'>+ New Chat</a>
            <nav class='chat-history-list'>
                {% for chat in all_chats %}
                <div class='chat-history-item-wrapper {% if chat.id == current_chat_id %}active{% endif %}'>
                    <a href='{{ url_for('chat', chat_id=chat.id) }}' class='chat-history-item'>
                        {{ chat.title }}
                    </a>
                    <div class='chat-options'>
                        <button class='kebab-btn' title='Chat options' data-chat-id='{{ chat.id }}' data-chat-title='{{ chat.title }}'>â‹®</button>
                        <div class='kebab-dropdown'>
                            <button type='button' class='rename-btn'>Rename</button>
                            <a href='{{ url_for('download_chat', chat_id=chat.id) }}'>Download</a>
                            <form action='{{ url_for('delete_chat', chat_id=chat.id) }}' method='POST' onsubmit='return confirm("Delete this chat permanently?");'>
                                <button type='submit'>Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </nav>
        </div>

        <div class='resizer' id='resizer'></div>

        <div class='container'>
            <div class='header'>
                <div class='header-left'>
                    <button class='menu-btn' id='menu-btn' title='Toggle Menu'>
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
                
                <div class='header-center'>
                    <h1 class='chat-title'>
                        {% if model_is_selected %}{{ current_chat.title }}{% else %}Gemini Chat{% endif %}
                    </h1>
                </div>
                
                <div class='header-right'>
                    <div class='agent-toggle'>
                        <span>Agent Mode</span>
                        <label class='switch'>
                            <input type='checkbox' id='agent-mode-toggle'>
                            <span class='slider'></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class='chat-window' id='chat-window'>
                {% for message in current_chat_messages %}
                    <div class='message {{ message.role }} {{ message.message_type }}'>
                        <div class='bubble'>
                            <div class='bubble-content'>{{ message.content | safe }}</div>
                            {% if message.message_type not in ['agent_plan', 'user_confirmation'] %}
                            <button class='copy-btn' title='Copy content'>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                  <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                  <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 1.5A1.5 1.5 0 0 1 .5 0h3A1.5 1.5 0 0 1 5 1.5v1A1.5 1.5 0 0 1 3.5 4h-3A1.5 1.5 0 0 1 -1 2.5v-1zM.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-3z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
                <div id='chat-end'></div>
            </div>
            
            {% if error %}
                <div class='error-banner'>
                    <strong>Application Error:</strong> {{ error }}
                </div>
            {% endif %}
            
            <form id='chat-form' class='chat-form'>
                <textarea 
                    id='prompt-input'
                    name='prompt' 
                    placeholder='{% if model_is_selected %}Enter your message or task... (Shift+Enter for new line){% else %}Please select a model to begin{% endif %}' 
                    autocomplete='off' 
                    required 
                    rows='1'
                    {% if not model_is_selected or error %}disabled{% endif %}
                ></textarea>
                <button 
                    type='submit' 
                    id='send-button'
                    {% if not model_is_selected or error %}disabled{% endif %}
                >Send</button>
            </form>
        </div>
    </div>
    
    <script>
        const menuBtn = document.getElementById('menu-btn');
        const appLayout = document.getElementById('app-layout');
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        
        menuBtn.addEventListener('click', () => {
            appLayout.classList.toggle('sidebar-hidden');
            if (appLayout.classList.contains('sidebar-hidden')) {
                resizer.style.pointerEvents = 'none';
            } else {
                resizer.style.pointerEvents = 'auto';
            }
        });

        const modalOverlay = document.getElementById('modal-overlay');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', function(event) {
                if (event.target === modalOverlay) { 
                    {% if fallback_chat_id %}
                    window.location.href = '{{ url_for('chat', chat_id=fallback_chat_id) }}';
                    {% else %}
                    window.location.href = '{{ url_for('index') }}';
                    {% endif %}
                }
            });
        }
    
        window.addEventListener('load', (event) => { scrollToBottom(); });

        const chatForm = document.getElementById('chat-form');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const chatWindow = document.getElementById('chat-window');
        const agentToggle = document.getElementById('agent-mode-toggle');

        // Agent Mode Toggle Persistence
        agentToggle.addEventListener('change', () => {
            localStorage.setItem('agentMode', agentToggle.checked);
        });

        function loadAgentMode() {
            const savedState = localStorage.getItem('agentMode');
            if (savedState === 'true') {
                agentToggle.checked = true;
            } else {
                agentToggle.checked = false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadAgentMode);

        chatForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            handleChatSubmit();
        });

        promptInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const scrollHeight = this.scrollHeight;
            const maxHeight = parseInt(getComputedStyle(this).maxHeight);

            if (scrollHeight > maxHeight) {
                this.style.overflowY = 'auto';
                this.style.height = maxHeight + 'px';
            } else {
                this.style.overflowY = 'hidden';
                this.style.height = scrollHeight + 'px';
            }
        });

        promptInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                chatForm.requestSubmit();
            }
        });

        async function handleChatSubmit() {
            const prompt = promptInput.value.trim();
            if (prompt === '') { return; }

            const agentMode = agentToggle.checked;

            promptInput.value = '';
            promptInput.disabled = true;
            promptInput.style.height = 'auto';
            promptInput.style.overflowY = 'hidden';
            sendButton.disabled = true;
            
            appendMessage('user', prompt, 'chat');
            const typingBubble = appendMessage('model', '<div class="typing-indicator"><span></span><span></span><span></span></div>', 'typing');
            
            scrollToBottom();

            try {
                const response = await fetch("{{ url_for('api_chat') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        'prompt': prompt,
                        'agent_mode': agentMode
                    }),
                });

                typingBubble.remove();
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }
                
                const data = await response.json();
                appendMessage(data.role, data.content, data.message_type, null, data.raw_plan);
                
                if (data.message_type === 'agent_plan') {
                    // Prompt stays disabled until user acts on the plan
                } else {
                    promptInput.disabled = false;
                    sendButton.disabled = false;
                    promptInput.focus();
                }
                
            } catch (error) {
                typingBubble.remove();
                appendMessage('model', `--- Error connecting to server: ${error.message} ---`, 'chat');
                console.error('Fetch Error:', error);
                
                promptInput.disabled = false;
                sendButton.disabled = false;
                promptInput.focus();
            } finally {
                scrollToBottom();
            }
        }
        
        async function executePlan(chatId) {
            let typingBubble = appendMessage('model', '<div class="typing-indicator"><span></span><span></span><span></span></div>', 'typing');
            scrollToBottom();
            
            try {
                let response = await fetch(`/api/execute_plan/${chatId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                while (response.ok) {
                    const data = await response.json();
                    typingBubble.remove();

                    if (data.status === 'proceed') {
                        typingBubble = appendMessage('model', '<div class="typing-indicator"><span></span><span></span><span></span></div>', 'typing');
                        scrollToBottom();
                        
                        response = await fetch(`/api/execute_plan/${chatId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                    } else if (data.status === 'confirmation_pending' || data.status === 'file_selection_pending') {
                        appendMessage('model', data.content, 'user_confirmation');
                        scrollToBottom();
                        return; 
                    } else if (data.status === 'complete') {
                        appendMessage('model', data.message, 'chat');
                        break; 
                    } else if (data.status === 'error') {
                        throw new Error(data.message);
                    }
                }
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }

            } catch (error) {
                typingBubble.remove();
                appendMessage('model', `--- Agent Error: ${error.message} ---`, 'chat');
            } finally {
                promptInput.disabled = false;
                sendButton.disabled = false;
                promptInput.focus();
                scrollToBottom();
                window.location.reload(); 
            }
        }
        
        async function handleAgentAction(chatId, actionType, actionData) {
            let typingBubble = appendMessage('model', '<div class="typing-indicator"><span></span><span></span><span></span></div>', 'typing');
            scrollToBottom();
            
            try {
                const response = await fetch('/api/agent_action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_type: actionType, action_data: actionData })
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }
                
                const data = await response.json();
                
                if (data.status === 'proceed') {
                    executePlan(chatId);
                } else {
                    throw new Error(data.message || 'Unknown error after action');
                }
                
            } catch (error) {
                appendMessage('model', `--- Agent Error: ${error.message} ---`, 'chat');
            } finally {
                typingBubble.remove();
                scrollToBottom();
            }
        }

        function handleFileSelection(event, chatId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const selectedFiles = formData.getAll('selected_files');
            
            form.closest('.message.user_confirmation').remove();
            
            handleAgentAction(chatId, 'process_selected_files', { selected_files: selectedFiles });
        }
        
        function cancelPlan() {
            document.querySelector('.message.agent_plan .plan-actions').closest('.message').remove();
            appendMessage('model', 'Agent plan cancelled by user.', 'chat');
            promptInput.disabled = false;
            sendButton.disabled = false;
            promptInput.focus();
        }

        function editPlan(button, chatId) {
            const bubble = button.closest('.bubble');
            const bubbleContent = bubble.querySelector('.bubble-content');
            const message = bubble.closest('.message');
            const rawPlan = message.dataset.rawPlan;

            if (!rawPlan) {
                alert('Error: Raw plan data not found.');
                return;
            }

            bubbleContent.innerHTML = `
                <textarea class="plan-editor">${JSON.stringify(JSON.parse(rawPlan), null, 2)}</textarea>
                <div class="plan-actions-edit">
                    <button onclick="savePlan(this, '${chatId}')">Save & Approve</button>
                    <button onclick="cancelEdit()">Cancel Edit</button>
                </div>
            `;
        }

        async function savePlan(button, chatId) {
            const bubbleContent = button.closest('.bubble-content');
            const textarea = bubbleContent.querySelector('.plan-editor');
            const newPlanJson = textarea.value;

            try {
                JSON.parse(newPlanJson); // Validate JSON
            } catch (e) {
                alert('Invalid JSON format. Please correct and try again.');
                return;
            }

            try {
                const response = await fetch('/api/save_plan/' + chatId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({plan_json: newPlanJson})
                });
                
                const data = await response.json();

                if (data.status === 'saved') {
                    bubbleContent.innerHTML = '<p>Plan saved. Executing...</p>';
                    executePlan(chatId);
                } else {
                    throw new Error(data.error || 'Failed to save plan');
                }
            } catch (err) {
                appendMessage('model', '--- Error saving plan: ' + err.message + ' ---', 'chat');
                scrollToBottom();
            }
        }

        function cancelEdit() {
            // Simple solution: reload the page to restore the original plan message
            window.location.reload();
        }


        const deletionModal = document.getElementById('deletion-modal-overlay');
        const deletionText = document.getElementById('deletion-modal-text');
        const deletionConfirmBtn = document.getElementById('deletion-confirm-btn');
        const deletionCancelBtn = document.getElementById('deletion-cancel-btn');
        let currentDeletionCommand = null;
        let currentChatId = null;
        
        function showDeletionModal(chatId, command) {
            currentDeletionCommand = command;
            currentChatId = chatId;
            deletionText.innerHTML = `The agent wants to run: <code>${command}</code><br><br>Are you sure you want to approve this command?`;
            deletionModal.style.display = 'flex';
        }
        
        deletionCancelBtn.addEventListener('click', () => {
            deletionModal.style.display = 'none';
            cancelPlan();
        });
        
        deletionConfirmBtn.addEventListener('click', () => {
            deletionModal.style.display = 'none';
            if (currentChatId && currentDeletionCommand) {
                document.querySelector('.message.user_confirmation').remove();
                handleAgentAction(currentChatId, 'confirm_deletion', { command: currentDeletionCommand });
            }
        });
        
        document.addEventListener('click', function(e) {
            // Handle deletion confirmation
            const approveBtn = e.target.closest('.plan-actions .approve-btn');
            if (approveBtn && approveBtn.closest('.message.user_confirmation')) {
                const messageBubble = approveBtn.closest('.message.user_confirmation');
                const code = messageBubble.querySelector('code');
                if (code) {
                    const command = code.innerText;
                    const chatId = '{{ current_chat_id }}';
                    showDeletionModal(chatId, command);
                }
            }
            
            // Handle deletion denial
            const cancelBtn = e.target.closest('.plan-actions .cancel-btn');
            if (cancelBtn && cancelBtn.closest('.message.user_confirmation')) {
                cancelPlan();
            }
        });


        function appendMessage(role, content, messageType = 'chat', bubbleClass = null, rawPlanJson = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role, messageType);
            
            if (rawPlanJson) {
                messageDiv.dataset.rawPlan = rawPlanJson;
            }
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('bubble');
            if (bubbleClass) { bubbleDiv.classList.add(bubbleClass); }

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('bubble-content');
            contentDiv.innerHTML = content; 
            
            bubbleDiv.appendChild(contentDiv);

            if (!bubbleClass && messageType !== 'agent_plan' && messageType !== 'user_confirmation') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.title = 'Copy content';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 1.5A1.5 1.5 0 0 1 .5 0h3A1.5 1.5 0 0 1 5 1.5v1A1.5 1.5 0 0 1 3.5 4h-3A1.5 1.5 0 0 1 -1 2.5v-1zM.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-3z"/></svg>`;
                
                copyBtn.addEventListener('click', () => {
                    const textToCopy = contentDiv.innerText;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        copyBtn.classList.add('copied');
                        setTimeout(() => copyBtn.classList.remove('copied'), 1500);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                    });
                });
                bubbleDiv.appendChild(copyBtn);
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatWindow.insertBefore(messageDiv, document.getElementById('chat-end'));
            return messageDiv;
        }

        function scrollToBottom() {
            const chatEnd = document.getElementById('chat-end');
            if (chatEnd) { chatEnd.scrollIntoView(); }
        }
        
        function initCopyButtons() {
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const bubble = button.closest('.bubble');
                    const content = bubble.querySelector('.bubble-content');
                    if (content) {
                        const textToCopy = content.innerText;
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            button.classList.add('copied');
                            setTimeout(() => button.classList.remove('copied'), 1500);
                        }).catch(err => {
                            console.error('Failed to copy: ', err);
                        });
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initCopyButtons();
        
            const resizerEl = document.getElementById('resizer');
            const sidebarEl = document.getElementById('sidebar');
            const minWidth = 200; 
            const maxWidth = window.innerWidth * 0.33; 
            let isResizing = false;

            resizerEl.addEventListener('mousedown', function (e) {
                isResizing = true;
                document.body.classList.add('is-resizing');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                let newWidth = e.clientX;
                if (newWidth < minWidth) newWidth = minWidth;
                if (newWidth > maxWidth) newWidth = maxWidth;
                sidebarEl.style.width = newWidth + 'px';
            }

            function handleMouseUp() {
                isResizing = false;
                document.body.classList.remove('is-resizing');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        });

        const renameModal = document.getElementById('rename-modal-overlay');
        const renameForm = document.getElementById('rename-form');
        const renameInput = document.getElementById('rename-input');
        const renameCancel = document.getElementById('rename-cancel-btn');

        document.querySelectorAll('.kebab-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); 
                const chatId = this.dataset.chatId;
                const chatTitle = this.dataset.chatTitle;
                
                const dropdown = this.nextElementSibling;
                const renameBtn = dropdown.querySelector('.rename-btn');
                
                renameBtn.onclick = function() {
                    renameForm.action = `/rename_chat/${chatId}`;
                    renameInput.value = (chatTitle === 'New Chat') ? '' : chatTitle;
                    renameModal.style.display = 'flex';
                    renameInput.focus();
                    dropdown.classList.remove('show');
                };

                document.querySelectorAll('.kebab-dropdown.show').forEach(d => d.classList.remove('show'));
                dropdown.classList.toggle('show');
            });
        });

        window.addEventListener('click', function(e) {
            document.querySelectorAll('.kebab-dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        });

        renameCancel.addEventListener('click', () => {
            renameModal.style.display = 'none';
        });
        renameModal.addEventListener('click', function(event) {
            if (event.target === renameModal) {
                renameModal.style.display = 'none';
            }
        });

    </script>
</body>
</html>